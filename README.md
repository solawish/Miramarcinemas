# 美麗華影城訂票助手

一個 Chrome 擴充功能，協助使用者快速完成美麗華影城的訂票流程，包括自動選擇座位和確認訂單。

## 功能特色

- 🎬 **電影與場次查詢**：自動從 API 取得最新電影列表和場次時間
- 🎫 **票種關鍵詞**：可選填關鍵詞（如全票、學生、套票）優先匹配票種；自動排除敬老/愛心，無關鍵詞時依全票→單人套票→第一個選擇
- 💺 **自動座位選擇**：根據票數自動選擇最佳座位（優先選擇 PhysicalName 較大的區域，同區選擇中間位置）
- 🔄 **資料快取**：5 分鐘快取機制，減少 API 請求次數
- 📝 **詳細日誌**：顯示完整的訂票流程處理過程，方便除錯
- ⚡ **一鍵訂票**：從選擇電影到完成確認，自動化整個流程

## 安裝方式

### 從原始碼安裝

1. 下載或複製此專案到本地
2. 開啟 Chrome 瀏覽器
3. 前往 `chrome://extensions/`
4. 開啟右上角的「開發人員模式」
5. 點擊「載入未封裝項目」
6. 選擇專案資料夾
7. 完成安裝

## 使用方法

### 前置準備

1. **登入網站**：請先在瀏覽器中開啟並登入 [美麗華影城網站](https://www.miramarcinemas.tw)

### 訂票流程

1. **開啟擴充功能**：點擊瀏覽器工具列中的擴充功能圖示
2. **選擇電影**：從下拉選單中選擇想要觀看的電影
3. **選擇場次**：選擇場次時間（可點擊「重新整理」按鈕更新場次資訊）
4. **票種關鍵詞**（選填）：輸入關鍵詞可優先匹配票種名稱（如「全票」「學生」「套票」）；留空則依預設順序（全票→單人套票→第一個）選擇，且會自動排除敬老/愛心票種
5. **選擇票數**：選擇要購買的票數（1-6 張）
6. **執行訂票**：點擊「訂購」按鈕，擴充功能會自動完成以下步驟：
   - 取得票種頁面
   - 解析並選擇票種
   - 提交訂票請求
   - 解析座位表並自動選擇座位
   - 提交座位選擇
   - 提交確認請求
   - 自動開啟付款頁面

### 查看處理過程

擴充功能會在下方的「處理過程」文字區域顯示詳細的執行日誌，包括：
- API 請求狀態
- 資料解析結果
- 錯誤訊息（如有）
- 各步驟的執行狀態

## 技術細節

### 架構

- **Manifest Version**: 3
- **前端技術**: HTML5, CSS3, JavaScript (ES6+)
- **儲存機制**: Chrome Storage API（用於快取）
- **API 通訊**: Fetch API

### 權限說明

- `activeTab`: 存取目前分頁
- `storage`: 儲存快取資料
- `cookies`: 讀取網站 cookies（用於驗證）
- `tabs`: 開啟新分頁（用於開啟付款頁面）
- `host_permissions`: 存取美麗華影城網站 API

### 主要功能模組

#### 資料取得與快取
- `fetchAllMovies()`: 從 API 取得所有電影資料
- `getCachedMovies()` / `setCachedMovies()`: 快取管理（5 分鐘過期）

#### 資料解析
- `parseMovies()`: 解析電影列表
- `parseTimeSlotsFromMovie()`: 從電影資料解析場次時間
- `parseTicketTypes()`: 解析票種資訊
- `parseSeatTable()`: 解析座位表

#### 自動化流程
- `selectTicketType(ticketTypes, keyword)`: 先排除敬老/愛心票種；若有關鍵詞則依關鍵詞匹配，否則依全票→單人套票→第一個選擇（以 tickettypetitlealt 為準）
- `selectSeats()`: 根據票數自動選擇最佳座位
- `handleOrder()`: 執行完整的訂票流程

#### API 呼叫
- `fetchTicketTypePage()`: 取得票種選擇頁面
- `submitOrder()`: 提交訂票請求
- `submitSeatSelection()`: 提交座位選擇
- `submitConfirm()`: 提交確認請求

### 座位選擇邏輯

擴充功能會根據以下規則自動選擇座位：

1. **區域優先**：優先選擇 `PhysicalName` 較大的區域（例如：E 區優於 A 區）
2. **中間位置**：在同一區域內，選擇 `SeatId` 的中間值
3. **分散選擇**：從中間位置向兩側擴散選擇

## 開發說明

### 專案結構

```
Miramarcinemas/
├── manifest.json          # Chrome Extension 設定檔
├── popup.html             # 彈出視窗 HTML
├── popup.js               # 主要邏輯 JavaScript
├── popup.css              # 樣式表
├── README.md              # 本文件
└── openspec/              # 專案規範與變更記錄
    ├── project.md         # 專案說明
    └── specs/             # 規格文件
```

### 程式碼規範

- **命名規則**：
  - 變數和函數：`camelCase`
  - 類別：`PascalCase`
  - 常數：`UPPER_SNAKE_CASE`
  - HTML ID：`kebab-case`
- **縮排**：2 個空格
- **字串引號**：單引號
- **註解**：使用 JSDoc 格式

### 除錯

擴充功能會在「處理過程」文字區域顯示詳細日誌，包括：
- 時間戳記
- API 請求/回應
- 資料解析結果
- 錯誤訊息

如果遇到問題，請檢查：
1. 是否已登入美麗華影城網站
2. 網路連線是否正常
3. 「處理過程」中的錯誤訊息

## 注意事項

⚠️ **重要提醒**：

1. **登入狀態**：使用前請確保已在瀏覽器中登入美麗華影城網站
2. **Cookie 權限**：擴充功能需要讀取網站 cookies 以進行驗證
3. **自動化限制**：此擴充功能僅協助自動化訂票流程，最終仍需使用者手動完成付款
4. **API 變更**：如果美麗華影城更新 API 或網站結構，可能需要更新擴充功能

## 授權

本專案僅供學習和研究使用。使用時請遵守美麗華影城的使用條款。

## 版本歷史

- **v1.1.0** (2026-01-29)
  - 票種改為關鍵詞輸入框（選填），可輸入關鍵詞優先匹配票種
  - 選票邏輯：先排除敬老/愛心，有關鍵詞則依關鍵詞選，否則全票→單人套票→第一個
  - 票種名稱以 tickettypetitlealt 為準

- **v1.0.0** (2026-01-28)
  - 初始版本
  - 基本訂票功能
  - 自動座位選擇
  - 資料快取機制

## 問題回報

如有問題或建議，請透過 GitHub Issues 回報。
